# metalsmith

## Context

As of Victoria the default is for Metalsmith to 
[provision baremetal before the overcloud deploy](https://docs.openstack.org/project-deploy-guide/tripleo-docs/latest/provisioning/baremetal_provision.html).

Using [tripleo-lab](../tripleo-lab) like this:

`ansible-playbook builder.yaml -t domains -t baremetal -t vbmc`

will result in tripleo-lab using the tripleo-operator-ansible role
[tripleo_overcloud_node_provision](https://opendev.org/openstack/tripleo-operator-ansible/src/branch/master/roles/tripleo_overcloud_node_provision)
to install an OS and assign an IP to every node planned for the
overcloud. This is a different way of working as I'm used to having
introspected nodes, not deployed nodes, when I first login to the
undercloud.

## SSH'ing into the provisioned nodes

After you login to your undercloud for the first time source the stackrc
and run `metalsmith list` the way you used to run `openstack server list`.

```
(undercloud) [CentOS-8.1 - stack@undercloud ~]$ metalsmith -c "Node Name" -c "IP Addresses" list
+------------------+------------------------+
| Node Name        | IP Addresses           |
+------------------+------------------------+
| oc0-controller-0 | ctlplane=192.168.24.19 |
| oc0-controller-1 | ctlplane=192.168.24.14 |
| oc0-controller-2 | ctlplane=192.168.24.16 |
| oc0-ceph-0       | ctlplane=192.168.24.8  |
| oc0-ceph-1       | ctlplane=192.168.24.24 |
| oc0-ceph-2       | ctlplane=192.168.24.17 |
| oc0-ceph-3       | ctlplane=192.168.24.22 |
| oc0-ceph-4       | ctlplane=192.168.24.7  |
| oc0-ceph-5       | ctlplane=192.168.24.15 |
+------------------+------------------------+
(undercloud) [CentOS-8.1 - stack@undercloud ~]$ 
```

You can then `ssh heat-admin@192.168.24.19`. The above list of nodes
will be based on the [metalsmith-0.yaml](metalsmith-0.yaml) topology.

## Overcloud Deployment

You should find a file in /home/stack like `overcloud-baremetal-deployed-0.yaml`:
```
(undercloud) [CentOS-8.1 - stack@undercloud ~]$ head -20 overcloud-baremetal-deployed-0.yaml 
parameter_defaults:
  CephStorageDeployedServerCount: 6
  CephStorageDeployedServerHostnameFormat: '%stackname%-cephstorage-%index%'
  ControllerDeployedServerCount: 3
  ControllerDeployedServerHostnameFormat: '%stackname%-controller-%index%'
  DeployedServerPortMap:
    ceph-0-ctlplane:
      fixed_ips:
      - ip_address: 192.168.24.8
      network:
        mtu: 1500
        tags:
        - 192.168.24.0/24
      subnets:
      - cidr: 192.168.24.0/24
        dns_nameservers:
        - 192.168.122.1
        gateway_ip: 192.168.24.1
        host_routes: []
    ceph-1-ctlplane:
(undercloud) [CentOS-8.1 - stack@undercloud ~]$ 
```

You can do your overcloud deployment by passing this file like this:

```
openstack overcloud deploy \
  -e /usr/share/openstack-tripleo-heat-templates/environments/deployed-server-environment.yaml \
  -e ~/overcloud-baremetal-deployed-0.yaml \
  --deployed-server \
  ...
```

and you'll basically be [Using Already Deployed Servers](https://docs.openstack.org/project-deploy-guide/tripleo-docs/latest/features/deployed_server.html) which will become the new default.

## Unprovisioning

You don't have to use what tripleo-lab stood up for you. You can just
shut all those nodes down like this:

```
openstack overcloud node unprovision --all \
  --stack oc0 \
  ~/metalsmith-0.yaml
```

Note that ~/metalsmith-0.yaml should have also been generated by
tripleo-lab.

You can also run [clean-disks.sh](clean-disks.sh) if you're cleaning
up after a Ceph deployment.

## Provisioning

Because tripleo-lab does this for you the first time I'm taking note
of it here:

```
openstack overcloud node provision \
  --stack oc0 \
  --output ~/overcloud-baremetal-deployed-0-new.yaml \
  ~/metalsmith-0.yaml
```

All of this is from the [existing docs](https://docs.openstack.org/project-deploy-guide/tripleo-docs/latest/provisioning/baremetal_provision.html)
but just put into the context of what I find when using tripleo-lab.

## Topologies

I normally use tripleo-lab to get a working undercloud with
introspected VMs and do everything else myself. tripleo-lab
assumes that what you have under `vms` for 
[tripleo-lab/overrides.yml](../tripleo-lab/overrides.yml)
is what you're actually going to deploy. This used to be no 
problem for me as it didn't actually deploy the baremetal that way in
one shot. Now that they're tightly coupled my current approach is:

- Let tripleo-lab provision all the virtual hardware to confirm
  metalsmith is working
- Login to the undercloud for the first time
- Take the hardware down `openstack overcloud node unprovision --all --stack oc0 ~/metalsmith-0.yaml`
- Maintain a set of toplogies to deploy different combinations of the
  virtual hardware
- For every type of deployment kept in this repo, directly reference
  the appropriate topology file

Each of the example deployments (e.g. standard or dcn) in this
repository has its own toplogy file.

## Scripts

The [provision.sh](provision.sh) and [unprovision.sh](unprovision.sh)
scripts take the stack name as an input parameter and will deploy the
nodes for the matching topology.
